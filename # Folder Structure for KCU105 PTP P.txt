# Folder Structure for KCU105 PTP Project

project_root/
â”œâ”€â”€ main.c                             # Application entry point
â”œâ”€â”€ ptpd.c                             # Full PTP daemon logic (you just pasted)
â”œâ”€â”€ ptpd.h                             # Header for ptpd.c (include declarations)
â”œâ”€â”€ platform/                          # Platform-specific files
â”‚   â”œâ”€â”€ platform.c                     # Clock setup, SFP config, etc.
â”‚   â””â”€â”€ platform.h
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ ptpd/                          # All PTP-related headers
â”‚   â”‚   â”œâ”€â”€ ptpd.h
â”‚   â”‚   â”œâ”€â”€ protocol.h
â”‚   â”‚   â”œâ”€â”€ servo.h
â”‚   â”‚   â””â”€â”€ constants.h
â”‚   â””â”€â”€ lwip/                          # lwIP headers (if not using system-wide lwIP)
â”œâ”€â”€ apps/                              # PTP protocol logic
â”‚   â”œâ”€â”€ protocol.c
â”‚   â”œâ”€â”€ protocol.h
â”‚   â”œâ”€â”€ servo.c
â”‚   â”œâ”€â”€ servo.h
â”œâ”€â”€ netif/                             # lwIP netif driver
â”‚   â”œâ”€â”€ ethernet.c                     # Generic Ethernet logic (from lwIP)
â”‚   â”œâ”€â”€ temacif.c                      # Xilinx-specific SGMII/SFP logic (to be written)
â”‚   â””â”€â”€ temacif.h
â”œâ”€â”€ CMakeLists.txt or Makefile         # For building bare metal on KCU105
â”œâ”€â”€ ptp_config.h                       # Optional: Configurable defines
â””â”€â”€ README.md

# Notes:
- `ptpd.c` contains all queue management, UDP binding, message send/receive, and time adjustment logic.
- `apps/protocol.c` will contain Sync, DelayReq, Follow_Up, Delay_Resp logic.
- `main.c` initializes platform, lwIP, and calls ptpd_periodic_handler() in a loop.
- `platform/` holds board-specific init like clock, Ethernet PHY/SFP setup.
- `include/ptpd/` contains PTP structures, enums, constants, and external function declarations.
- `netif/` includes only necessary low-level drivers like `temacif.c`, excluding unrelated interfaces like SLIP, PPP, ZEP, etc.



             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  UDP PCB   â”‚â—„â”€â”€â”€â”€â”€ udp_new()
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          udp_recv(â€¦, callback, â€¦)
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Packet â†’  â”‚  Callback Fn   â”‚â—„â”€â”€â”€ udp_bind(â€¦, PTP_PORT)
          â”‚  (event/gen)   â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ PTP Queue    â”‚
         â”‚ (event_q /   â”‚
         â”‚  general_q)  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
        ptpd_net_recv()
              â–¼
         Protocol handler

1. Vivado Hardware Platform Prep (already assumed ready)
You've said your Vivado block design is done. Make sure of the following:

âœ… MicroBlaze system with:

DDR4 + MIG

Ethernet via AXI TEMAC + FIFO + DMA or AXI Ethernet Lite (MAC)

Clocking Wizard (125 MHz or 200 MHz)

âœ… Interrupt Controller if needed (optional in polling loop)

âœ… Exported XSA file (File â†’ Export Hardware â†’ Include bitstream)

ğŸ§± 2. Create a Vitis Platform Project
Open Vitis IDE â†’ New Platform Project:

Import the .xsa you exported from Vivado

Give it a name like kcu105_ptp_platform

Vitis will automatically recognize hardware peripherals:

DDR4 memory, Ethernet, UART, timers

ğŸ’» 3. Create an Application Project (Bare Metal)
File â†’ New Application Project

Choose the kcu105_ptp_platform as the hardware platform

Target processor: microblaze_0

OS: Standalone

Template: choose Empty Application

Name it: ptp_baremetal_app

ğŸ“ 4. Import Your Software Files
Your current software is organized into a project root. Here's how to bring it in:

Copy These into src/ folder of the app:
main.c

ptpd.c, ptpd.h

ptp_config.h

Create subfolders:
swift
Copy
Edit
src/
â”œâ”€â”€ main.c
â”œâ”€â”€ ptpd.c
â”œâ”€â”€ ptpd.h
â”œâ”€â”€ ptp_config.h
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ protocol.c
â”‚   â”œâ”€â”€ protocol.h
â”‚   â”œâ”€â”€ servo.c
â”‚   â””â”€â”€ servo.h
â”œâ”€â”€ platform/
â”‚   â”œâ”€â”€ platform.c
â”‚   â””â”€â”€ platform.h
â”œâ”€â”€ include/
â”‚   â””â”€â”€ ptpd/
â”‚       â”œâ”€â”€ constants.h
â”‚       â”œâ”€â”€ ptpd.h
â”‚       â”œâ”€â”€ protocol.h
â”‚       â””â”€â”€ servo.h
â”œâ”€â”€ netif/
â”‚   â”œâ”€â”€ temacif.c
â”‚   â””â”€â”€ temacif.h
âš™ï¸ 5. Configure the Build
Includes paths (Vitis â†’ Project Settings â†’ C/C++ Build â†’ Settings â†’ Includes):

css
Copy
Edit
src/
src/include/
src/include/ptpd/
src/apps/
src/platform/
src/netif/
Defines (for raw lwIP use and options):

ini
Copy
Edit
-DLWIP_RAW=1
-DLWIP_TIMEVAL_PRIVATE=0
-DNO_SYS=1
Compiler Flags:

diff
Copy
Edit
-O2 -g -Wall
ğŸŒ 6. Setup lwIP
You need to:

Use the lwIP standalone port

Enable only essential features in lwipopts.h:

c
Copy
Edit
#define NO_SYS                      1
#define LWIP_SOCKET                0
#define LWIP_NETCONN               0
#define LWIP_RAW                   1
#define LWIP_UDP                   1
#define LWIP_ICMP                  0
#define LWIP_TCP                   0
#define MEM_ALIGNMENT              4
#define MEMP_NUM_PBUF              16
#define PBUF_POOL_SIZE             8
#define LWIP_DHCP                  1  // Optional
Place lwipopts.h inside include/ or platform/

ğŸ”Œ 7. temacif.c Integration
In temacif.c, make sure you:

Implement low_level_init() using xemacpsif or temac_adapter

Implement low_level_output() and low_level_input() to handle buffers

Register the interface with netif_add() in your platform_init()

ğŸ§ª 8. Run on KCU105
Connect UART, Ethernet (SFP or RJ45), and JTAG

Program the board via Vitis

Open UART terminal (115200 baud)

You should see logs like:

vbnet
Copy
Edit
ptpd: startup...
ptpd: joined multicast group...
ptpd: Sync sent...
Optionally, test with another PTP instance (like ptpd on a Linux PC)

ğŸ“¡ 9. Timestamping (Optional)
If your hardware supports it (e.g., via MAC timestamp registers), you can:

Extend pbuf with time fields

Read timestamps in ptpd_net_recv and ptpd_net_send

Would you like me to generate a full Vitis-ready folder as a ZIP, or walk through the temacif.c and platform.c implementation next?







You said:
where should you write these commands?Defines (for raw lwIP use and options):

ini
Copy
Edit
-DLWIP_RAW=1
-DLWIP_TIMEVAL_PRIVATE=0
-DNO_SYS=1
Compiler Flags:

diff
Copy
Edit
-O2 -g -Wall


ChatGPT said:
Great question.

In Vitis, to set the compiler flags and preprocessor defines, you do this through the Application Project settings. Hereâ€™s how:

âœ… Where to set:
Vitis IDE GUI
Right-click on your Application Project (e.g., ptp_baremetal_app)

Click Properties

Go to C/C++ Build â†’ Settings

Under the Tool Settings tab, do the following:

ğŸ§© Preprocessor Defines (e.g., -DLWIP_RAW=1)
Go to:
C Compiler â†’ Preprocessor â†’ Defined symbols

Click Add (+) and enter:

ini
Copy
Edit
LWIP_RAW=1
LWIP_TIMEVAL_PRIVATE=0
NO_SYS=1
ğŸ›  Compiler Flags (e.g., -O2 -g -Wall)
Go to:
C Compiler â†’ Miscellaneous â†’ Other flags

Add:

diff
Copy
Edit
-O2 -g -Wall
ğŸ“ If using a Makefile instead
In your Makefile, add these lines:

make
Copy
Edit
CFLAGS += -O2 -g -Wall
CFLAGS += -DLWIP_RAW=1 -DLWIP_TIMEVAL_PRIVATE=0 -DNO_SYS=1
